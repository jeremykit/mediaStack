# 直播录制与点播系统 - 需求文档

## 1. 项目概述

开发一套Web系统，实现以下核心功能：
- 直播流录制（支持多种协议）
- 录像在线点播播放
- MP4文件上传与点播

## 2. 功能需求

### 2.1 直播录制模块

| 需求项 | 说明 |
|--------|------|
| 支持协议 | RTMP推流、RTSP拉流、HLS/M3U8 |
| 录制触发 | 自动录制（检测到流自动开始）+ 手动控制（开始/停止）+ 定时录制 |
| 并发能力 | 支持5路以内同时录制 |
| 输出格式 | MP4 |
| 存储位置 | 本地服务器磁盘 |
| 保留时长 | 可配置，默认1年，到期自动删除 |

**功能清单：**
- 添加/编辑/删除直播源配置（名称、协议类型、地址、保留时长、默认分类/标签）
- 定时录制计划配置（如：每周六8点开始）
- 直播源状态监控（在线/离线/录制中）
- 手动开始/停止录制
- 自动录制开关配置
- 录制任务列表与状态查看

**录制规则：**
- 文件命名：按时间自动命名（格式：`直播源名称_YYYYMMDD_HHmmss.mp4`）
- 不分段录制，整个直播录制为单个文件
- 超过保留时长的录像自动清理
- 同一直播源可周期性录制，每次录制生成独立文件

**录制流程：**
1. 直播源开始录制 → 生成录制文件
2. 录制完成 → 文件进入"待审核"状态
3. 管理员在"录制文件管理"中编辑扩展信息并审核
4. 审核通过 → 文件发布到点播模块

### 2.2 录制文件管理模块

| 需求项 | 说明 |
|--------|------|
| 文件状态 | 待审核、已发布、已下架 |
| 管理范围 | 所有直播录制产生的文件 |

**功能清单：**
- 录制文件列表（按直播源、日期、状态筛选）
- 文件信息编辑：
  - 基本信息（标题、描述、分类、标签）
  - 关联多张图片
  - 关联文本内容（富文本/备注）
  - 关联外部链接
- 文件审核（通过/拒绝）
- 批量操作（批量审核、批量删除）
- 发布/下架管理

### 2.3 文件上传模块

| 需求项 | 说明 |
|--------|------|
| 视频格式 | MP4 |
| 音频格式 | MP3、WAV、AAC、FLAC |
| 文件大小 | 支持大文件上传（分片上传） |
| 转码处理 | 不需要，直接存储原始文件 |

**功能清单：**
- 视频文件上传（MP4，支持拖拽上传）
- 音频文件上传（MP3/WAV/AAC/FLAC，支持拖拽上传）
- 上传进度显示
- 文件信息编辑（标题、描述、分类、标签）
- 视频封面设置（自动截取或手动上传）
- 音频封面设置（手动上传）
- 分类管理（添加/编辑/删除分类）
- 标签管理
- 文件扩展信息管理：
  - 关联多张图片
  - 关联文本内容（富文本/备注）
  - 关联外部链接

### 2.4 点播播放模块

| 需求项 | 说明 |
|--------|------|
| 视频来源 | 录制视频 + 上传视频（统一管理） |
| 播放控制 | 播放、暂停、进度拖动、音量调节 |
| 倍速播放 | 0.5x / 1x / 1.5x / 2x |
| 音频功能 | 支持纯音频播放、音频下载（提取MP3） |
| 视频下载 | 仅管理员可下载 |
| 观看统计 | 记录每个视频的观看次数 |

**权限说明：**
- 视频播放：访客可用（需观看码）
- 音频播放：访客可用（需观看码）
- 音频下载：访客可用（需观看码）
- 视频下载：仅管理员

**功能清单：**
- 视频列表展示（缩略图、标题、时长、上传时间、观看次数）
- 视频搜索与筛选（按名称、日期、来源类型、分类、标签）
- 视频详情页与播放器
- 音频播放模式（仅播放音频）
- 音频下载（从视频提取音频）
- 视频下载功能（管理员）
- 观看次数统计与展示
- 视频片段分享功能（管理员）：
  - 视频预览播放器
  - 指定开始/结束时间点
  - 一键复制M3U8播放链接（带时间参数）
  - 根据时间段生成MP3文件，支持：
    - 复制MP3链接
    - 在线播放
    - 下载MP3文件

### 2.5 观看码系统

| 需求项 | 说明 |
|--------|------|
| 访问控制 | 访客访问需输入观看码 |
| 权限范围 | 每个观看码可绑定一个或多个分类 |
| 管理功能 | 管理员可创建/编辑/删除/启用/禁用观看码 |

**功能清单：**
- 观看码管理（创建、编辑、删除、启用/禁用）
- 观看码绑定分类（设置可访问的视频分类范围）
- 访客输入观看码验证
- 观看码使用记录（可选）

### 2.6 系统管理模块

| 需求项 | 说明 |
|--------|------|
| 用户体系 | 仅管理员登录，普通用户可直接观看 |
| 权限控制 | 管理员：全部功能；访客：仅观看和下载 |

**服务器状态监控（管理后台顶部展示）：**
- 磁盘空间：剩余容量 / 总容量（如：25G / 100G）
- 内存使用率：百分比显示（如：75%）
- CPU使用率：百分比显示（如：67%）
- 实时带宽：入口带宽 / 出口带宽（如：78kbps / 5679kbps）
- 当前在线观看人数

**功能清单：**
- 管理员登录/登出
- 服务器状态实时监控
- 存储空间统计
- 系统配置（存储路径、录制参数等）

## 3. 非功能需求

| 类别 | 要求 |
|------|------|
| 性能 | 支持5路直播同时录制；点播支持50+并发观看 |
| 兼容性 | 支持Chrome、Firefox、Edge等主流浏览器 |
| 响应式 | 支持PC端和移动端访问 |

## 4. 技术选型

| 层级 | 技术 |
|------|------|
| 后端 | Python (FastAPI) |
| 前端 | Vue 3 + Element Plus |
| 数据库 | SQLite / PostgreSQL |
| 流媒体处理 | FFmpeg（录制、音频提取） |
| 点播服务 | nginx-vod-module（MP4实时转HLS/M3U8） |
| 播放器 | Video.js / DPlayer |

**nginx-vod-module 说明：**
- 项目地址：https://github.com/kaltura/nginx-vod-module
- 功能：实时将 MP4 转封装为 HLS/M3U8，无需预先转码
- 支持时间裁剪（clipping），可指定播放起止时间
- 支持音频流单独输出

## 5. 页面清单

1. **观看码输入页** - 访客首次访问时输入观看码
2. **首页** - 视频/音频列表展示（支持按分类/标签筛选，显示观看次数）
3. **详情页** - 播放器 + 文件信息 + 扩展内容（图片/文本/链接）+ 音频播放/下载
4. **管理后台**
   - 直播源管理（含定时录制计划配置）
   - 录制文件管理（待审核/已发布/已下架，编辑扩展信息）
   - 上传文件管理（视频/音频上传、编辑、删除）
   - 分类与标签管理
   - 观看码管理
   - 系统设置
5. **登录页** - 管理员登录

## 6. 安全需求

| 需求项 | 说明 |
|--------|------|
| 传输加密 | 全站 HTTPS，HLS 流使用 HTTPS 传输 |
| 管理员认证 | JWT Token，有效期可配置，支持强制登出 |
| 密码策略 | 最小8位，包含字母+数字 |

## 7. 错误处理与告警

| 场景 | 处理策略 |
|------|----------|
| 录制中网络中断 | 自动重连3次，间隔10秒；失败后保存已录制内容，状态标记为"录制中断" |
| 磁盘空间不足 | 使用率达到90%时触发告警，支持 Webhook 通知（可配置消息内容和接收地址） |

## 8. 数据模型

### 实体关系
- 直播源 1:N 录制文件
- 录制文件/上传文件 N:1 分类
- 录制文件/上传文件 N:M 标签
- 观看码 N:M 分类
- 文件 1:N 关联图片/文本/链接

### 核心字段约束
| 实体 | 字段 | 约束 |
|------|------|------|
| 视频文件 | 大小上限 | 10GB |
| 视频文件 | 时长上限 | 12小时 |
| 音频文件 | 大小上限 | 1GB |
| 分类名称 | 长度 | 2-32字符 |
| 标签名称 | 长度 | 1-16字符 |
| 观看码 | 格式 | 6-12位字母数字 |

## 9. 定时录制规则

在 2.1 节基础上补充：
- 支持 cron 表达式配置（如：`0 8 * * 6` 表示每周六8点）
- 不设置录制时长上限，录制持续到直播结束
- 支持一次性定时任务和周期性任务
- 冲突处理：同一直播源已在录制时，定时任务跳过

## 10. 音频提取规格

| 参数 | 默认值 |
|------|--------|
| 格式 | MP3 |
| 码率 | 128kbps |
| 采样率 | 44100Hz |
| 声道 | 立体声 |

## 11. 日志与审计

| 日志类型 | 内容 |
|----------|------|
| 操作日志 | 管理员登录/登出、文件审核/发布/删除、配置变更 |
| 访问日志 | 观看码验证、视频播放记录（IP、时间、时长） |
| 保留策略 | 默认保留90天，可配置 |

## 12. 部署需求

| 项目 | 要求 |
|------|------|
| 操作系统 | Ubuntu 20.04+ / Debian 11+ |
| 最低配置 | 4核CPU、8GB内存、100GB存储 |
| 依赖服务 | FFmpeg 5.0+、Nginx 1.20+、Python 3.10+ |
| 容器化 | 提供 Docker Compose 一键部署 |
| 环境变量 | 数据库连接、存储路径、JWT密钥等通过环境变量配置 |

## 13. 降级策略

| 场景 | 处理方案 |
|------|----------|
| 录制并发超限 | 排队等待，通知管理员 |
| 点播并发超限 | 返回"服务繁忙"提示，优先保障已连接用户 |
| 存储空间紧张 | 禁止新上传，仅允许删除操作 |
